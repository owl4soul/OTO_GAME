// –ú–æ–¥—É–ª—å 7.2: API RESPONSE - –ü–∞—Ä—Å–∏–Ω–≥ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (7-2-api-response.js)
'use strict';

import { CONFIG } from './1-config.js';
import { Utils } from './2-utils.js';

const Prompts = CONFIG.prompts;

// –°–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π JSON, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—à –∫–æ–¥ –∏–≥—Ä—ã –û–ñ–ò–î–ê–ï–¢ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç LLM.
// –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –∫–æ—Ä–Ω–µ JSON –±—É–¥—É—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å –ò–ò" (aiMemory).
const KNOWN_FIELDS = [
    "scene",                    // [string] –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã
    "choices",                  // [Array<string>] –ú–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
    "reflection",               // [string, optional] –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è –∏–ª–∏ –∫—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥ —Å—Ü–µ–Ω—ã
    "stat_changes",             // [Object] –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–≥—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, {"will": -5})
    "progress_change",          // [number] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ—Å–≤—è—â–µ–Ω–∏—è
    "personality_change",       // [string, optional] –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –≥–µ—Ä–æ—è
    "start_ritual",             // [string, optional] –§–ª–∞–≥/—É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∏—Ç—É–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "I¬∞")
    "end_ritual",               // [boolean, optional] –§–ª–∞–≥ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∏—Ç—É–∞–ª–∞
    "ritual_completed",         // [boolean, optional] –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–ª–∞–≥ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∏—Ç—É–∞–ª–∞
    "inventory",                // [Array<string>, optional] –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –∏ –≤ aiMemory, –Ω–æ –∑–¥–µ—Å—å –¥–ª—è —è–≤–Ω–æ—Å—Ç–∏)
    "thoughtsOfHeroResponse",   // [Array<string>, optional] –ú–∞—Å—Å–∏–≤ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ - "–º—ã—Å–ª–µ–π –≥–µ—Ä–æ—è"
    "short_summary"             // [string] –û–î–ù–û –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–π —Å—Ü–µ–Ω—ã (–¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–≤–æ–¥–∫–∏)
];

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò.
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç RAW-—Ç–µ–∫—Å—Ç LLM –≤ –æ–±—ä–µ–∫—Ç JavaScript, –≥–æ—Ç–æ–≤—è –µ–≥–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∏–≥—Ä–µ.
 * 
 * @param {string} rawText - –°—ã—Ä–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç LLM.
 * @returns {Object} –û–±—ä–µ–∫—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π { cleanData: {–∏–≥—Ä–æ–≤—ã–µ_–¥–∞–Ω–Ω—ã–µ}, memoryUpdate: {–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è_–ø–∞–º—è—Ç—å} }.
 * @throws {Error} –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –Ω–∏–∫–∞–∫–æ–º—É –ø–∞—Ä—Å–∏–Ω–≥—É JSON.
 */
function processAIResponse(rawText) {
    // 1. –û—á–∏—Å—Ç–∫–∞ Markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ RAW-—Ç–µ–∫—Å—Ç–∞ LLM.
    // LLM –∏–Ω–æ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç JSON –≤ ```json ```, —ç—Ç–æ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º.
    let cleanText = rawText.trim()
        .replace(/^```json\s*/i, '')  // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—á–∞–ª–∞ JSON-–±–ª–æ–∫–∞
        .replace(/\s*```$/i, '')      // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ü–∞ JSON-–±–ª–æ–∫–∞
        .replace(/^```\s*/i, '');     // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ ``` –±–µ–∑ `json`

    // 2. –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON.
    let parsedData;
    try {
        parsedData = JSON.parse(cleanText);
    } catch (standardParseError) {
        // –ï—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π JSON.parse() –ø–∞–¥–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –∫–∞–≤—ã—á–µ–∫ –∏–ª–∏ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—è—Ç—ã—Ö),
        // –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–π (robust) –ø–∞—Ä—Å–µ—Ä –∏–∑ `Utils`.
        console.warn("JSON.parse() failed with standard parser. Attempting robust parsing.", standardParseError);
        parsedData = Utils.robustJsonParse(cleanText);
    }

    // 3. –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞–ª–∏—á–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ø–æ–ª–µ–π (Fail-safe mechanism).
    // –ï—Å–ª–∏ LLM –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,
    // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ UI –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å –∏–≥—Ä—ã.
    if (!parsedData.scene) {
        parsedData.scene = "–û—à–∏–±–∫–∞: –ò–ò –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã. –ü–æ–≥—Ä—É–∂–∞—é—â–∞—è —Ç—å–º–∞ –ø–æ–≥–ª–æ—Ç–∏–ª–∞ –≤—Å–µ.";
    }
    
    if (!parsedData.choices || !Array.isArray(parsedData.choices) || parsedData.choices.length === 0) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –∏–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.
        parsedData.choices = ["–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Å–º—ã—Å–ª–∏—Ç—å –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–µ–µ..."];
    }

    // 4. –î–ï–¢–ï–ö–¢–û–† –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–• –ü–û–õ–ï–ô (Unknown Fields Extractor).
    // –≠—Ç–æ —Å–µ—Ä–¥—Ü–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ –ò–ò" (aiMemory).
    // –õ—é–±–æ–µ –ø–æ–ª–µ –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –æ–±—ä–µ–∫—Ç–µ JSON, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ `KNOWN_FIELDS`,
    // –±—É–¥–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ `memoryUpdate`.
    const dynamicMemoryUpdates = {};
    
    for (const [key, value] of Object.entries(parsedData)) {
        if (!KNOWN_FIELDS.includes(key)) {
            // –ù–∞–π–¥–µ–Ω –Ω–æ–≤—ã–π –∫–ª—é—á, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–π—Å—è –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–≥—Ä—ã!
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è aiMemory –≤ State.
            dynamicMemoryUpdates[key] = value;
            console.log(`üß† [AI Memory] Discovered and saved dynamic field: '${key}' with value:`, value);
        }
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏—à–µ–ª –≤ –∫–æ—Ä–Ω–µ, –¥—É–±–ª–∏—Ä—É–µ–º –µ–≥–æ –≤ –ø–∞–º—è—Ç—å
        if (key === 'inventory') {
            dynamicMemoryUpdates[key] = value;
        }
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–≤–µ —á–∞—Å—Ç–∏: 
    // `cleanData` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è `Game.js`
    // `memoryUpdate` - –æ–±—ä–µ–∫—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–ª—è–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `aiMemory` –≤ `State.js`
    return {
        cleanData: parsedData,
        memoryUpdate: dynamicMemoryUpdates 
    };
}

/**
 * –†–µ–∞–ª–∏–∑—É–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ API LLM —Å –º–µ—Ö–∞–Ω–∏–∑–º–æ–º "–ê–≤—Ç–æ-–†–µ–º–æ–Ω—Ç–∞" JSON (Robust Fetch with Auto-Repair).
 * –ï—Å–ª–∏ LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è "—É–±–µ–¥–∏—Ç—å" LLM –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ—é –æ—à–∏–±–∫—É.
 * 
 * @param {string} url - URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ API.
 * @param {Object} headers - –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.
 * @param {Object} payload - –ò—Å—Ö–æ–¥–Ω–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è, –º–æ–¥–µ–ª—å).
 * @param {number} attemptsLeft - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–º–æ–Ω—Ç–∞ JSON.
 * @param {Object} apiRequestModule - –ú–æ–¥—É–ª—å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –±–∞–∑–æ–≤—ã–π –º–µ—Ç–æ–¥ executeFetch.
 * @param {AbortController} abortCtrl - –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {Promise<Object>} –ü—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑—Ä–µ—à–∏—Ç—Å—è –≤ –æ–±—ä–µ–∫—Ç { cleanData, memoryUpdate } –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ä–µ–º–æ–Ω—Ç–∞.
 * @throws {Error} –í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (—Å–µ—Ç—å, –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫, –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≤–∞–ª –ø–∞—Ä—Å–∏–Ω–≥–∞).
 */
async function robustFetchWithRepair(url, headers, payload, attemptsLeft, apiRequestModule, abortCtrl) {
    try {
        // –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ apiRequestModule.
        const rawApiResponse = await apiRequestModule.executeFetch(url, headers, payload, abortCtrl);
        
        // –®–∞–≥ 2: –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã) –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM.
        const contentFromAI = rawApiResponse.choices?.[0]?.message?.content;
        if (!contentFromAI) {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –æ—à–∏–±–∫–æ–π.
            throw new Error("Received empty content string from AI provider in response.choices[0].message.content.");
        }

        // –®–∞–≥ 3: –ü—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∫ JSON.
        try {
            return processAIResponse(contentFromAI);
        } catch (jsonProcessingError) {
            // –ï—Å–ª–∏ `processAIResponse` –±—Ä–æ—Å–∏–ª –æ—à–∏–±–∫—É (–∑–Ω–∞—á–∏—Ç, –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –ø–ª–æ—Ö–∏–º JSON),
            // –º—ã –ª–æ–≤–∏–º —ç—Ç—É –æ—à–∏–±–∫—É –∑–¥–µ—Å—å –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–º–æ–Ω—Ç–∞.
            throw new Error(`Invalid JSON format detected. Raw text: "${contentFromAI.substring(0, 200)}..." \nDetails: ${jsonProcessingError.message}`);
        }

    } catch (primaryError) {
        // ============================================
        // –õ–û–ì–ò–ö–ê –ê–í–¢–û-–†–ï–ú–û–ù–¢–ê (Auto-Repair Logic)
        // ============================================

        // A. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –æ—à–∏–±–æ–∫ (–Ω–µ –ø–æ–¥–ª–µ–∂–∞—Ç —Ä–µ–º–æ–Ω—Ç—É LLM):
        // - –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (fetch, HTTP 4xx/5xx).
        // - –û—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ (AbortError).
        // –í —ç—Ç–∏—Ö —Å–ª—É—á–∞—è—Ö LLM –Ω–∏—á–µ–≥–æ –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤—ã—à–µ.
        const isCriticalError = primaryError.message.startsWith('HTTP Error') || 
                                primaryError.name === 'AbortError' || 
                                primaryError.message.includes('fetch');
                               
        if (isCriticalError) {
            throw primaryError; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Facade/Game
        }

        // B. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ü–ê–†–°–ò–ù–ì–ê JSON (–ø–æ–¥–ª–µ–∂–∞—Ç —Ä–µ–º–æ–Ω—Ç—É LLM):
        // –ï—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –∏ —É –Ω–∞—Å –ï–©–ï –ï–°–¢–¨ –ü–û–ü–´–¢–ö–ò –†–ï–ú–û–ù–¢–ê:
        if (attemptsLeft > 0) {
            console.warn(`‚ö†Ô∏è [AI Repair] Previous AI response was broken JSON. Initiating auto-repair... Attempts left: ${attemptsLeft}`);
            console.warn(`Original parse error: ${primaryError.message}`);
            
            // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ payload (—Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞),
            // —á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞.
            const newPayloadForRepair = JSON.parse(JSON.stringify(payload)); 
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ messages.
            // –≠—Ç–æ "—É–±–µ–∂–¥–∞–µ—Ç" LLM –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –∏ –≤—ã–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.
            newPayloadForRepair.messages.push({
                role: "user",
                content: Prompts.technical.jsonRepair // –ë–µ—Ä–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Ä–µ–º–æ–Ω—Ç—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            });

            // –í—ã–ø–æ–ª–Ω—è–µ–º –†–ï–ö–£–†–°–ò–í–ù–´–ô –≤—ã–∑–æ–≤ —ç—Ç–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏, —É–º–µ–Ω—å—à–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫.
            // –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Ü–∏–∫–ª "–ø–æ–ø—Ä–æ–±—É–π -> –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ -> –ø–æ–ø—Ä–æ—Å–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å -> –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞".
            return robustFetchWithRepair(
                url, 
                headers, 
                newPayloadForRepair, 
                attemptsLeft - 1,   // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                apiRequestModule, 
                abortCtrl
            );
        }

        // C. –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞ –ò–°–ß–ï–†–ü–ê–ù–´ ‚Äî —Å–¥–∞–µ–º—Å—è.
        // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞, —á—Ç–æ–±—ã UI –ø–æ–∫–∞–∑–∞–ª –µ–µ –∏–≥—Ä–æ–∫—É.
        throw new Error(`CRITICAL: AI failed to produce valid JSON after ${CONFIG.autoRepairAttempts} repair attempts. Last error: ${primaryError.message}`);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –º–æ–¥—É–ª—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏.
export const API_Response = {
    processAIResponse,
    robustFetchWithRepair
};